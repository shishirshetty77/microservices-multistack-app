name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'helm/**'
      - 'k8s/**'
      - 'README.md'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'helm/**'
      - 'k8s/**'
      - 'README.md'

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  # Replace with your actual Docker Hub username if hardcoding is preferred, 
  # but using secrets is best practice. if you ask me use secrets
  IMAGE_OWNER: shishir77 

jobs:
  
  
  check-user-service:
    name: User Service (Go)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      - name: Verify dependencies
        working-directory: ./user-service
        run: go mod download
      - name: Run Vet (Static Analysis)
        working-directory: ./user-service
        run: go vet ./...
      - name: Run Tests
        working-directory: ./user-service
        run: go test -v ./...
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './user-service'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

  check-product-service:
    name: Product Service (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        working-directory: ./product-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pylint pytest
      - name: Check for Syntax Errors
        working-directory: ./product-service
        run: python -m compileall src/
      - name: Run Pylint
        working-directory: ./product-service
        # Fail on errors only (E), ignore convention/refactor messages for now
        run: pylint --disable=C,R,W src/ || true 
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './product-service'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

  check-order-service:
    name: Order Service (Java)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Build and Test
        working-directory: ./order-service
        run: |
          chmod +x mvnw
          ./mvnw clean verify

  check-notification-service:
    name: Notification Service (Node.js)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install dependencies
        working-directory: ./notification-service
        run: npm install
      - name: Check Syntax & Lint
        working-directory: ./notification-service
        # Using npx to run eslint without modifying package.json
        run: npx eslint src/ || true
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './notification-service'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

  check-analytics-service:
    name: Analytics Service (Rust)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: clippy
      - name: Check Code (Clippy)
        working-directory: ./analytics-service
        run: cargo clippy -- -D warnings
      - name: Run Tests
        working-directory: ./analytics-service
        run: cargo test
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './analytics-service'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

  check-frontend:
    name: Frontend (React)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install dependencies
        working-directory: ./frontend
        run: npm install
      - name: Build Check
        working-directory: ./frontend
        run: npm run build
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './frontend'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
  
  
  build-and-push:
    needs: 
      - check-user-service
      - check-product-service
      - check-order-service
      - check-notification-service
      - check-analytics-service
      - check-frontend
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      matrix:
        service: 
          - name: user-service
            context: ./user-service
          - name: product-service
            context: ./product-service
          - name: order-service
            context: ./order-service
          - name: notification-service
            context: ./notification-service
          - name: analytics-service
            context: ./analytics-service
          - name: frontend
            context: ./frontend
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          push: true
          tags: |
            ${{ env.IMAGE_OWNER }}/${{ matrix.service.name }}:latest
            ${{ env.IMAGE_OWNER }}/${{ matrix.service.name }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.IMAGE_OWNER }}/${{ matrix.service.name }}:buildcache
          cache-to: type=registry,ref=${{ env.IMAGE_OWNER }}/${{ matrix.service.name }}:buildcache,mode=max

  # ==================================================================================
  # 3. UPDATE HELM CHART & COMMIT
  # ==================================================================================

  update-helm-version:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Install YQ
        run: |
          wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Bump Chart Version
        run: |
          # Increment patch version in Chart.yaml
          CURRENT_VERSION=$(yq '.version' charts/microservices-app/Chart.yaml)
          NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          yq -i ".version = \"$NEW_VERSION\"" charts/microservices-app/Chart.yaml
          echo "Bumped Chart version from $CURRENT_VERSION to $NEW_VERSION"

      - name: Update Image Tags in Values
        run: |
          # Update all service image tags to the new Git SHA
          SHA="${{ github.sha }}"
          
          # Note: We are updating the 'image' field which currently contains "repo/image:tag"
          # We need to construct the full image string
          
          OWNER="${{ env.IMAGE_OWNER }}"
          
          yq -i ".userService.image = \"$OWNER/user-service:$SHA\"" charts/microservices-app/values.yaml
          yq -i ".productService.image = \"$OWNER/product-service:$SHA\"" charts/microservices-app/values.yaml
          yq -i ".orderService.image = \"$OWNER/order-service:$SHA\"" charts/microservices-app/values.yaml
          yq -i ".notificationService.image = \"$OWNER/notification-service:$SHA\"" charts/microservices-app/values.yaml
          yq -i ".analyticsService.image = \"$OWNER/analytics-service:$SHA\"" charts/microservices-app/values.yaml
          yq -i ".frontend.image = \"$OWNER/frontend:$SHA\"" charts/microservices-app/values.yaml
          
          echo "Updated values.yaml with image tag $SHA"

      - name: Commit and Push Changes
        run: |
          git add charts/microservices-app/Chart.yaml charts/microservices-app/values.yaml
          git commit -m "ci: bump helm chart version and update image tags [skip ci]"
          git push
